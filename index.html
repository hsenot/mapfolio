<!DOCTYPE html>
<html>
<head>
	<title>SolarSize - Drawing solar panels</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="../dist/leaflet.ie.css" /><![endif]-->
	<style>
		/* Base HTML */
		body {
			margin:10px;
		}
		form {
			margin: 10px;
		}
		input[type="text"] {
			font-size:12px;
		}

		/* Bootstrap */
		.well {
			border-radius: 8px 8px 8px 8px;
			padding: 8px;
			margin-bottom: 8px;
		}
		.spanmap {
 		   width: 610px;
		}
		.row {
		    margin-left: 0px;
		}
		[class*="span"] {
			margin-right: 10px;
			margin-left: 0;
		}

		/* Leaflet */		
		.leaflet-container .leaflet-control-attribution {
			font-size: 8px;
		}

		/* Misc */
		.centered {
			text-align: center;
		}

	</style>
</head>
<body>
	<div class="row">
		<div class="spanmap">
			<div class="well" style="width: 592px;">
				Total roof area displayed: <p id="total_roof_area" style="display:inline;">calculating ...</p>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="spanmap">
			<div class="well" style="width: 592px;">
				<div id="map" style="width: 592px; height: 592px; border: 1px;"></div>
			</div>
		</div>
	</div>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
	<script src="leaflet/leaflet.js"></script>
	<script src="leaflet-plugins/layer/tile/Bing.js"></script>
	<script>

		var map, refreshBuildings, buildingVectorLayer, totalRoofAreaDisplayed = 0, zoomToBuilding;

		function numberWithCommas(x) {
		    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function initmap() {
			// Set up the map
			map = L.map('map').setView([-37.815,144.963], 16);
			// Create the Bing layer and add it to the map
			var binglayer = new L.BingLayer('AgxcV_eHKN9sD_UzjdBKiXru-b_mGfIKjD1SkgR0zJhhGQAAKqFvTs442gc1Eaay','Aerial')
				.addTo(map);

			refreshBuildings = function(){
				// Loading indicator
				$('#total_roof_area').html("calculating ...");
				// fetching the new features based on the new 
				$.ajax({
					type : 'GET',
					dataType : 'json',
					data: {
						geotable:'osm_buildings',
						geomfield:'the_geom',
						fields:'osm_id,name,round(ST_Area(ST_Transform(the_geom,3111))::numeric,0) as area_m2',
						limit: 200,
						orderby:'ST_Distance(the_geom,ST_SetSRID(ST_Point('+map.getCenter().lng+','+map.getCenter().lat+'),4326))',
						sort:'ASC'
					},
					url: 'ws/postgis_geojson.php?bbox=' + map.getBounds().toBBoxString(),
					success : function(data) {
						// object made of osm_id
						var new_ids = {};
						for (f in data.features){
							if (data.features.hasOwnProperty(f)) {
								new_ids[data.features[f].properties.osm_id]=f;
							}	
						}
						// Remove existing features from the layer
						if (buildingVectorLayer)
						{
							//map.removeLayer(buildingVectorLayer);
							for (f in buildingVectorLayer._layers)
							{
								if (buildingVectorLayer._layers[f].feature.properties.osm_id in new_ids)
								{
									data.features.splice(new_ids[buildingVectorLayer._layers[f].feature.properties.osm_id],1);
								}
								else
								{
									delete buildingVectorLayer._layers[f];
								}
							}
							totalRoofAreaDisplayed = 0;
						}
						// Adding the new features
						buildingVectorLayer = L.geoJson(data,{
						    style: function (feature) {
						    	var fcolor = 'red';
						    	if (feature.properties.name)
						    	{
						    		fcolor = 'green';
						    	}
						        return {
						        	color: fcolor,
						        	weight: 3,
						        	opacity: 0.3
						    	};
						    },
						    onEachFeature: function (feature, layer) {
						    	var feature_name = feature.properties.name;
						    	totalRoofAreaDisplayed = totalRoofAreaDisplayed + parseInt(feature.properties.area_m2);
						    	if (!feature_name)
						    	{
						    		feature_name = "Unknown";
						    	}
						    	var htmlArray = [];
						    	htmlArray.push("<b>"+feature_name+"</b>");
						    	htmlArray.push("<br>Approx area: "+numberWithCommas(feature.properties.area_m2)+" m<sup>2</sup>");
						    	htmlArray.push("Zoom to <a href='#"+feature.properties.osm_id+"' onClick='zoomToBuilding("+feature.properties.osm_id+")'>this building</a>");
						        layer.bindPopup(htmlArray.join("<br>"),{keepInView:true});
						    }
						}).addTo(map);

						// Refresh the total roof area displayed
						$('#total_roof_area').html(numberWithCommas(totalRoofAreaDisplayed)+" m<sup>2</sup>");
					} 
				});				
			}

		}

		initmap();
		map.on('moveend',refreshBuildings)
		refreshBuildings();

		zoomToBuilding = function(buildingId){ 
			// Assumption is that the building exists in the current vector layer
			for (f in buildingVectorLayer._layers)
			{
				if (buildingVectorLayer._layers[f].feature.properties.osm_id==buildingId)
				{
					buildingVectorLayer._layers[f].closePopup();
					map.fitBounds(buildingVectorLayer._layers[f].getBounds());
					break;
				}
			}
		}

	</script>
</body>
</html>
