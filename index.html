<!DOCTYPE html>
<html>
<head>
	<title>SolarSize - Drawing solar panels</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="bootstrap/tag-manager/bootstrap-tagmanager.css" rel="stylesheet">
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<link rel="stylesheet" href="leaflet.draw/leaflet.draw.css" />
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="leaflet.ie.css" />
		<link rel="stylesheet" href="leaflet.draw/leaflet.draw.ie.css" />
	<![endif]-->
	<style>
		/* Base HTML */
		body {
			margin:10px;
		}
		form {
			margin: 0px;
		}
		input[type="text"] {
		    font-size: 11px;
		    height: 12px;
		    margin-bottom: 2px;
		}

		/* Bootstrap */
		.well {
			border-radius: 8px 8px 8px 8px;
			padding: 8px;
			margin-bottom: 8px;
		}
		.spanmap {
 		   width: 610px;
		}
		.row {
		    margin-left: 0px;
		}
		[class*="span"] {
			margin-right: 10px;
			margin-left: 0;
		}
		.modal{
		    left: 254px;
		    margin-left: 0;
		    top: 110px;
		    width: 360px;
		}
		.btn-mini {
			font-size: 11px;
		}

		/* Leaflet */		
		.leaflet-container .leaflet-control-attribution {
			font-size: 8px;
		}

		.tm-input {
			width:50px;
		}

		.tm-tag {
			color: #FFFFFF;
			text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
			font-size: 10px;
		}

		/* Misc */
		.centered {
			text-align: center;
		}

		.inlineblock {
			display: inline-block;
		}

	</style>
</head>
<body>

	<div class="row">
		<div class="spanmap">
			<div class="row">
				<div class="well inlineblock" style="width:140px;">
					<p style="display:inline-block;font-size:12px;line-height:15px;text-align:center;">Total building area identified within the map:</p> <p id="total_roof_area" style="font-size:15px;text-align:center">calculating ...</p>
				</div>

				<div id="tagTally" class="well inlineblock" style="margin-left:4px;width:425px;vertical-align:top;">
					Loading tags ...
				</div>

			</div>
		</div>
	</div>

	<div class="row">
		<div class="spanmap">
			<div class="well" style="width: 592px;">
				<div id="deleteBuildingModal" class="modal hide" data-backdrop="false">
				    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<div class="modal-body">
					Are you sure you want to delete this building?
					<button type="button" id="deleteBuildingBtn" class="btn">Yes</button>
				  </div>
				</div>

				<div id="map" style="width: 592px; height: 592px; border: 1px;"></div>
			</div>
		</div>
	</div>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="bootstrap/tag-manager/bootstrap-tagmanager.js"></script>
	<script src="leaflet/leaflet.js"></script>
	<script src="leaflet-plugins/layer/tile/Bing.js"></script>
	<script src="leaflet.draw/leaflet.draw.js"></script>
	<script>

		var map, refreshBuildings, buildingVectorLayer, buildingDetailsJSON, buildingPopupToOpen, totalRoofAreaDisplayed = 0, moveToBuilding, drawnItems, layerToCreate, layersToDelete, editBuildingDetails;
		// Removed: 'black'
		var css_colors = ['aqua', 'blue', 'fuchsia', 'gray', 'green', 'lime', 'maroon', 'navy', 'olive', 'orange', 'purple', 'red', 'silver', 'teal', 'white', 'yellow'];
		var animateOptions = {animate:true,duration:1,easeLinearity:0.1};
		function numberWithCommas(x) {
		    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function initmap() {
			// Set up the map
			map = L.map('map').setView([-37.815,144.963], 16).on('removelayer',function(f){
				alert("removing layer"+f);
			});
			// Create the Bing layer and add it to the map
			var binglayer = new L.BingLayer('AgxcV_eHKN9sD_UzjdBKiXru-b_mGfIKjD1SkgR0zJhhGQAAKqFvTs442gc1Eaay','Aerial')
				.addTo(map);

			buildingVectorLayer = L.geoJson({features:[],type:"FeatureCollection"},{
			    style: function (feature) {
			    	var fcolor = 'red';
			    	if (feature.properties.lga)
			    	{
			    		fcolor = css_colors[parseInt(feature.properties.lga) % css_colors.length];
			    	}
			        return {
			        	color: fcolor,
			        	weight: 3,
			        	opacity: 0.3
			    	};
			    },
			    onEachFeature: function (feature, layer) {
			    	var feature_name = feature.properties.name;
			    	totalRoofAreaDisplayed = totalRoofAreaDisplayed + parseInt(feature.properties.area_m2);
			    	if (!feature_name)
			    	{
			    		feature_name = "Unknown";
			    	}
			    	var htmlArray = [];
			    	htmlArray.push("<div id='selectedBuildingExtraProperties'><img src='ajax-loader.gif'></div>");
			    	htmlArray.push(	"<a class='btn btn-mini' href='#"+feature.properties.id+"' onClick='moveToBuilding("+feature.properties.id+",'zoom')'><i class='icon-zoom-in'></i> Zoom</a>&nbsp;"+
			    					"<a class='btn btn-mini' href='#"+feature.properties.id+"' onClick='editBuildingDetails("+feature.properties.id+")'><i class='icon-pencil'></i> Edit</a>&nbsp;"+
			    					"<a class='btn btn-mini' href='#"+feature.properties.id+"' onClick='deleteBuilding("+feature.properties.id+")'><i class='icon-trash'></i> Delete</a>");
			        layer.bindPopup(htmlArray.join("<br>"),{keepInView:true,minWidth:250});
			    }
			}).addTo(map);

			map.on('popupopen', function(e) {
				// ID of the building whose popup is open
				var bid = e.popup._source.feature.id;
				// Loading additional properties using AJAX
				$.ajax({
					type : 'GET',
					dataType : 'json',
					data: {building_id:bid},
					url:'ws/read_building.php',
					success : function(data) {
						var buildingDetailsHTML='';
						buildingDetailsJSON=data.rows[0];
						// Looping thru all attributes for this building
						for (d in buildingDetailsJSON)
						{
							// Might need to adapt the presentation to each type of attribute
							// This is a read-only presentation - could the markup be the same for edit (form)?
							buildingDetailsHTML += "<li>"+d+": "+buildingDetailsJSON[d]+"</li>";
						}
						// Injecting extra properties
						$('#selectedBuildingExtraProperties').html(buildingDetailsHTML);


					}
				});

				moveToBuilding(bid,'pan');
			});

			drawnItems = new L.FeatureGroup();
			map.addLayer(drawnItems);

			var drawControl = new L.Control.Draw({
				draw: {
					// Other positions just don't work
					position: 'topleft',
					polyline:false,
					rectangle:false,
					circle:false,
					marker:false,
					polygon: {
						title: 'Draw a building',
						allowIntersection: false,
						drawError: {
							color: '#b00b00',
							timeout: 1000
						},
						shapeOptions: {
							color: '#bada55'
						},
						showArea: false
					}
				},
				edit: {
					featureGroup: buildingVectorLayer,
					edit: false
				}
			});

			// Tooltip overrides before the control is added to the map
			L.drawLocal.draw.toolbar.buttons.polygon = "Draw a building roof";
			///L.drawLocal.edit.toolbar.buttons.remove = "Delete a building roof";

			map.addControl(drawControl);

			$('#createBuildingModal').modal({show:false,backdrop:false});

			map.on('draw:created', function (e) {
				var type = e.layerType,
					layer = e.layer;

				// Transforming the Leaflet layer into a WKT geometry ingestible by PostGIS
				var geomWKT = "POLYGON((";
				var lla = layer.getLatLngs();
				for (var i=0;i<lla.length;i++)
				{
					geomWKT += lla[i].lng+" "+lla[i].lat+",";
				}
				geomWKT += lla[0].lng+" "+lla[0].lat+"))";

				// Passing the layer to create as a global
				layerToCreate = layer;
				map.addLayer(layer);

				// Sending the building with its name and other elements to the create service
				$.ajax({
					type : 'POST',
					dataType : 'json',
					data: {geom:geomWKT},
					url:'ws/insert_building.php',
					success : function(data) {
						// Move to the new building: this will trigger the layer redraw and we don't need to keep the temporary drawn structure on the map!
						map.fitBounds(layerToCreate.getBounds(), animateOptions);
						map.removeLayer(layerToCreate);
						layerToCreate = null;

						// Finding newly created layer based on building ID, and opening the corresponding popup
						buildingPopupToOpen = data.building_id;
					}
				});

				$('#createBuildingModal').addClass('hide');
			});

			map.on('draw:deleted', function (e) {
				var layers = e.layers;

				// Passing the layer to create as a global
				layersToDelete = layers;

				// Opening up a Bootstrap modal
				$('#deleteBuildingModal').removeClass('hide');

			});	

			$('#deleteBuildingBtn').click(function(){
				var buildingIdList='';
				layersToDelete.eachLayer(function(l){
					buildingIdList += l.feature.id+",";
				});
				buildingIdList = buildingIdList.substring(0,buildingIdList.length-1);
				// Sending the building with its name and other elements to the create service
				$.ajax({
					type : 'POST',
					dataType : 'json',
					data: {'building_ids': buildingIdList},
					url:'ws/delete_building.php',
					success : function(data) {
						// Tidying up the client
						map.removeLayer(layersToDelete);
						layersToDelete = null;

						refreshTagTally();
					}
				});

				$('#deleteBuildingModal').addClass('hide');
			});

			refreshBuildings = function(){
				// Loading indicator
				$('#total_roof_area').html("calculating ...");
				// fetching the new features based on the new 
				$.ajax({
					type : 'GET',
					dataType : 'json',
					data: {
						geotable:'community.building',
						geomfield:'the_geom',
						// Status: 0 => imported, 1=> created by user, 2 => deleted
						parameters:'status <> 2',
						fields:'id,name,round(ST_Area(ST_Transform(the_geom,3111))::numeric,0) as area_m2',
						limit: 100,
						orderby:'ST_Distance(the_geom,ST_SetSRID(ST_Point('+map.getCenter().lng+','+map.getCenter().lat+'),4326))',
						sort:'ASC'
					},
					url: 'ws/postgis_geojson.php?bbox=' + map.getBounds().toBBoxString(),
					success : function(data) {
						// object made of id
						var new_ids = {};
						for (f in data.features){
							if (data.features.hasOwnProperty(f)) {
								new_ids[data.features[f].properties.id]=true;
							}	
						}
						// Remove existing features from the layer
						if (buildingVectorLayer)
						{
							//map.removeLayer(buildingVectorLayer);
							for (f in buildingVectorLayer._layers)
							{
								var current_feature = buildingVectorLayer._layers[f];
								if (current_feature.feature.properties.id in new_ids)
								{
									new_ids[current_feature.feature.properties.id]=false;
								}
								else
								{
									// Updating roof area by substracting the areas of features we remove
									totalRoofAreaDisplayed = totalRoofAreaDisplayed - parseInt(current_feature.feature.properties.area_m2);
									// Deleting only this feature - clearLayers would remove all features
									buildingVectorLayer.removeLayer(buildingVectorLayer._layers[f]);
								}
							}
						}

						// Only getting the features from data where new_ids is true
						var data_trimmed = {features:[],type:"FeatureCollection"};
						for (f in data.features)
						{
							if (data.features.hasOwnProperty(f)) {
								if (new_ids[data.features[f].properties.id])
								{
									data_trimmed.features.push(data.features[f]);
								}
							}
						}

						// Adding the new features
						buildingVectorLayer.addData(data_trimmed);

						// Refresh the total roof area displayed
						$('#total_roof_area').html(numberWithCommas(totalRoofAreaDisplayed)+" m<sup>2</sup>");

						// Popup to open?
						if (buildingPopupToOpen)
						{
							for (f in buildingVectorLayer._layers)
							{
								if (buildingVectorLayer._layers[f].feature.properties.id==buildingPopupToOpen)
								{
									var popupAnchorPoint = buildingVectorLayer._layers[f].getBounds().getCenter();
									buildingVectorLayer._layers[f].openPopup(popupAnchorPoint);
									buildingPopupToOpen=null;
									break;
								}
							}
						}
					} 
				});				
			}

		}

		initmap();
		map.on('moveend',refreshBuildings)
		refreshBuildings();
		$(".tm-input").tagsManager({
			typeahead: true,
			typeaheadAjaxSource: 'ws/tag_list.php',
			typeaheadAjaxPolling: true
		});

		// List the tags and their respective weight
		refreshTagTally = function(){
			// Refreshing the tally of tags
			$.ajax({
				type : 'GET',
				dataType : 'json',
				url:'ws/tag_count.php',
				success : function(data) {
					var tagTally='';
					// Tidying up the client
					for (i=0;i<data.rows.length;i++)
					{
						tagTally += "<button class='btn btn-mini btn-primary' type='button'>" + data.rows[i].label + "</button> X " + data.rows[i].c + "&nbsp;&nbsp;&nbsp;";
					}
					// Injecting
					$('#tagTally').html(tagTally);
				}
			});
		};

		refreshTagTally();

		moveToBuilding = function(buildingId,moveType){ 
			// Assumption is that the building exists in the current vector layer
			for (f in buildingVectorLayer._layers)
			{
				if (buildingVectorLayer._layers[f].feature.properties.id==buildingId)
				{
					//buildingVectorLayer._layers[f].closePopup();
					if (moveType == 'pan')
					{
						map.panTo(buildingVectorLayer._layers[f].getBounds().getCenter(),animateOptions);
					}
					if (moveType == 'zoom')
					{
						map.fitBounds(buildingVectorLayer._layers[f].getBounds(),animateOptions);
					}
					break;
				}
			}
		}

		editBuildingDetails = function(buildingID){
			// Inject the form into the popup
			var updateForm = '<form id="updateBuildingForm"> \
				    	<fieldset> \
							<input type="text" id="buildingName" class="input-small" name="name" placeholder="Building name" value="'+buildingDetailsJSON.name+'"><br>\
							<input type="text" name="tags" placeholder="Add tags" class="tm-input"/> \
						</fieldset> \
						<button type="button" id="updateBuildingBtn" class="btn btn-mini">Save</button> \
				    </form>';

			$('#selectedBuildingExtraProperties').html(updateForm);

			$(".tm-input").tagsManager({
				prefilled: buildingDetailsJSON.tags.split(','),
				typeahead: true,
				typeaheadAjaxSource: 'ws/tag_list.php',
				typeaheadAjaxPolling: true,
				tagClass:'btn-primary btn-mini'
			});

			$('#updateBuildingBtn').click(function(){
				// To transmit:
				var formData = $('#updateBuildingForm').serialize();

				// Sending the building with its name and other elements to the create service
				$.ajax({
					type : 'POST',
					dataType : 'json',
					data: formData,
					url:'ws/update_building.php',
					success : function(data) {
						// Reset form values for subsequent building creations
						$('#updateBuildingForm').each (function(){
							this.reset();
						});

						refreshTagTally();
					}
				});

				$('#createBuildingModal').addClass('hide');
			});


		}

		deleteBuilding = function(buildingID){
			// Bringing in the delete button confirmation
			// reconstitute the layersToDelete from the building ID
			// then show the delete confirmation button
		}

	</script>
</body>
</html>
